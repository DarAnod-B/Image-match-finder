# Поиск семантических аналогов изображений

Скрипт предназначен для сравнения двух групп изображений и поиска семантических дубликатов. Основной сценарий использования — поиск "чистых" версий изображений (`Group 2`), которые соответствуют версиям с водяными знаками (`Group 1`).

Инструмент способен определять, что два изображения являются одной и той же сценой, даже при наличии значительных искажений, таких как:
*   Большие и непрозрачные водяные знаки (watermarks).
*   Изменения в яркости, контрастности и цветовой гамме.
*   Небольшие изменения в кадрировании или разрешении.
*   Артефакты сжатия (JPEG).

По итогам работы скрипт формирует финальный список изображений, где каждая картинка из первой группы заменена на свой "чистый" аналог из второй, если таковой был найден.

## Режимы работы

Инструмент поддерживает два режима работы:

1.  **Режим Redis (по умолчанию):** Основной режим. Все входные данные (пути к изображениям, CSV-файл с метаданными) получаются из **Redis**. После обработки результат (обновленный CSV) также сохраняется обратно в Redis. Этот режим предназначен для интеграции в более крупные системы.
2.  **Локальный режим:** Режим для отладки и автономной работы. Данные читаются напрямую из локальных папок, указанных в файле `settings.py`. Включается специальным флагом `--local`.

## Ключевые технологии

В основе инструмента лежит гибридный подход, сочетающий скорость классического компьютерного зрения и надежность геометрической верификации:

1.  **ORB (Oriented FAST and Rotated BRIEF):** Быстрый и эффективный алгоритм для нахождения тысяч уникальных "ключевых точек" (углов, текстур) на каждом изображении и создания их цифровых "отпечатков" — дескрипторов.
2.  **Brute-Force Matcher с фильтром Лоу:** Надежный метод для поиска наилучших совпадений между дескрипторами двух изображений. Фильтр Лоу (Lowe's Ratio Test) отсеивает неоднозначные и слабые совпадения, значительно повышая качество.
3.  **RANSAC (Random Sample Consensus):** Мощный алгоритм для **геометрической верификации**. Он проверяет, подчиняются ли найденные совпадения единой геометрической трансформации (поворот, масштаб, сдвиг). Это позволяет отличать настоящие совпадения от случайных.
4.  **Кэширование дескрипторов:** Для повышения производительности, инструмент предварительно обрабатывает базовую группу (`Group 2`) и сохраняет их дескрипторы в бинарный кэш-файл (`.pkl`).

## Структура проекта

Проект имеет модульную структуру для лучшей читаемости и поддержки.

```
image-match-finder/
├── core/
│   ├── __init__.py
│   ├── cacher.py         # Логика создания кэша дескрипторов
│   ├── searcher.py       # Логика поиска по кэшу и сравнения
│   └── utils.py          # Вспомогательные функции (валидация, ресайз)
│
├── data_loader.py        # Модуль, отвечающий за загрузку путей к файлам
├── image_link_manager.py # Менеджер для работы с CSV (get/set/save)
├── logger.py             # Настройка логгирования
├── main.py               # Точка входа: парсинг аргументов и запуск
├── pipeline.py           # "Оркестратор": определяет последовательность шагов
├── redis_handler.py      # Функции для получения данных из Redis
├── settings.py           # Конфигурация для локального режима и CV-алгоритмов
└── requirements.txt      # Список зависимостей проекта
```

## Установка

Для работы инструмента требуется Python 3.8 или выше.

1.  **Клонируйте репозиторий:**
    ```bash
    git clone https://github.com/YourUsername/image-match-finder.git
    cd image-match-finder
    ```

2.  **Создайте и активируйте виртуальное окружение (рекомендуется):**
    ```bash
    # Создать окружение
    python -m venv venv

    # Активировать в Windows
    .\venv\Scripts\activate

    # Активировать в macOS/Linux
    source venv/bin/activate
    ```

3.  **Установите все необходимые зависимости:**
    ```bash
    pip install -r requirements.txt
    ```

## Конфигурация

### Режим Redis (по умолчанию)

Конфигурация для этого режима осуществляется через **переменные окружения**:

*   `REDIS_HOST`: Адрес хоста Redis (по умолчанию: `localhost`).
*   `REDIS_PORT`: Порт Redis (по умолчанию: `6379`).
*   `CHAT_ID`: Уникальный идентификатор сессии/пользователя, используемый для формирования ключей в Redis. **Этот параметр обязателен.**

Перед запуском убедитесь, что в Redis загружены необходимые данные по ключам, которые ожидает `redis_handler.py`.

### Локальный режим

Этот режим использует настройки из файла `settings.py`. В этом же файле находятся и технические параметры для алгоритмов компьютерного зрения.

```python
# settings.py

# --- ПУТИ ДЛЯ ЛОКАЛЬНОГО РЕЖИМА ---
GROUP_1_DIR = r"C:\path\to\your\watermarked_images"
GROUP_2_DIR = r"C:\path\to\your\clean_images_database"
DESCRIPTORS_CACHE_PATH = "descriptors_cache.pkl"

# --- ТЕХНИЧЕСКИЕ ПАРАМЕТРЫ АЛГОРИТМОВ ---
RESIZE_WIDTH = 800
RESIZE_HEIGHT = 800
ORB_N_FEATURES = 2000
RANSAC_MIN_INLIERS = 15
```

## Использование

### Запуск в режиме Redis (по умолчанию)

1.  **Установите переменную окружения `CHAT_ID`:**

    *   Для **macOS/Linux**:
        ```bash
        export CHAT_ID=123456789
        ```
    *   Для **Windows (cmd)**:
        ```bash
        set CHAT_ID=123456789
        ```

2.  **Запустите скрипт:**
    ```bash
    python main.py
    ```
    Скрипт автоматически подключится к Redis, получит данные, выполнит поиск аналогов и обновит CSV-данные в Redis.

### Запуск в локальном режиме

1.  **Настройте пути** в файле `settings.py` (`GROUP_1_DIR` и `GROUP_2_DIR`).

2.  **Запустите скрипт с флагом `--local`:**
    ```bash
    python main.py --local
    ```
    В этом режиме скрипт будет работать только с локальными файлами и не будет пытаться подключиться к Redis. Переменная `CHAT_ID` не требуется.