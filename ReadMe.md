# Поиск семантических аналогов изображений

Скрипт предназначен для сравнения двух групп изображений и поиска семантических дубликатов. Основной сценарий использования — поиск "чистых" версий изображений (`Group 2`), которые соответствуют версиям с водяными знаками (`Group 1`).

Инструмент способен определять, что два изображения являются одной и той же сценой, даже при наличии значительных искажений, таких как:
*   Большие и непрозрачные водяные знаки (watermarks).
*   Изменения в яркости, контрастности и цветовой гамме.
*   Небольшие изменения в кадрировании или разрешении.
*   Артефакты сжатия (JPEG).

По итогам работы скрипт формирует финальный список изображений, где каждая картинка из первой группы заменена на свой "чистый" аналог из второй, если таковой был найден.

## Режимы работы

Инструмент поддерживает два режима работы:

1.  **Режим Redis (по умолчанию):** Основной режим. Все входные данные (пути к изображениям, CSV-файл с метаданными) получаются из **Redis**. После обработки результат (обновленный CSV) также сохраняется обратно в Redis. Этот режим предназначен для интеграции в более крупные системы.
2.  **Локальный режим:** Режим для отладки и автономной работы. Данные читаются напрямую из локальных папок, указанных в файле `settings.py`. Включается специальным флагом `--local`.

## Ключевые технологии

В основе инструмента лежит гибридный подход, сочетающий скорость классического компьютерного зрения и надежность геометрической верификации:

1.  **ORB (Oriented FAST and Rotated BRIEF):** Быстрый и эффективный алгоритм для нахождения тысяч уникальных "ключевых точек" на каждом изображении и создания их цифровых "отпечатков" — дескрипторов.
2.  **Brute-Force Matcher с фильтром Лоу:** Надежный метод для поиска наилучших совпадений между дескрипторами двух изображений.
3.  **RANSAC (Random Sample Consensus):** Мощный алгоритм для **геометрической верификации**, позволяющий отличать настоящие совпадения от случайных.
4.  **Кэширование дескрипторов:** Для повышения производительности, инструмент предварительно обрабатывает базовую группу (`Group 2`) и сохраняет их дескрипторы в кэш-файл.

## Структура проекта

Проект имеет модульную структуру для лучшей читаемости и поддержки.

```
image-match-finder/
├── core/
│   ├── __init__.py
│   ├── cacher.py         # Логика создания кэша дескрипторов
│   ├── searcher.py       # Логика поиска по кэшу и сравнения
│   └── utils.py          # Вспомогательные функции (валидация, ресайз)
│
├── data_loader.py        # Модуль, отвечающий за загрузку путей к файлам
├── image_link_manager.py # Менеджер для работы с CSV (get/set/save)
├── logger.py             # Настройка логгирования
├── main.py               # Точка входа: парсинг аргументов и запуск
├── pipeline.py           # "Оркестратор": определяет последовательность шагов
├── redis_handler.py      # Функции для получения данных из Redis
├── settings.py           # Конфигурация для локального режима и CV-алгоритмов
└── requirements.txt      # Список зависимостей проекта
```

## Установка

Для работы инструмента требуется Python 3.8 или выше.

1.  **Клонируйте репозиторий:**
    ```bash
    git clone https://github.com/DarAnod-B/Image-match-finder.git
    cd image-match-finder
    ```

2.  **Создайте и активируйте виртуальное окружение (рекомендуется):**
    ```bash
    # Создать окружение
    python -m venv venv
    # Активировать
    source venv/bin/activate  # macOS/Linux
    .\venv\Scripts\activate   # Windows
    ```

3.  **Установите все необходимые зависимости:**
    ```bash
    pip install -r requirements.txt
    ```

## Конфигурация

### Переменные окружения (для режима Redis)

Эти переменные должны быть установлены в среде, где запускается скрипт.

| Переменная | Описание | Пример | Обязательность |
| :--- | :--- | :--- | :--- |
| **`CHAT_ID`** | Уникальный идентификатор сессии/задачи. Используется для формирования всех ключей в Redis. | `123456789` | **Обязательная** |
| `REDIS_HOST`| Адрес сервера Redis. | `localhost` | Опциональная |
| `REDIS_PORT`| Порт сервера Redis. | `6379` | Опциональная |

### Данные в Redis (для режима Redis)

Это данные, которые должны быть предварительно загружены в Redis. `{CHAT_ID}` заменяется на значение из переменной окружения.

| Ключ в Redis | Тип данных Redis | Содержимое | Обязательность |
| :--- | :--- | :--- | :--- |
| **`{CHAT_ID}:csv:raw`** | **String** | Строка, содержащая полный текст CSV-файла. В этом файле должна быть колонка со ссылками на изображения для `Group 1` (с водяными знаками). | **Обязательный** |
| **`{CHAT_ID}:group2_images`** | **List** | Список строк. Каждая строка — это путь к одному "чистому" изображению из `Group 2`. | **Обязательный** |
| `{CHAT_ID}:KEEP_UNMATCHED` | **String** | Строка `'true'` или `'false'`. Определяет, нужно ли сохранять изображения без аналога. Детали см. ниже. | **Опциональный** |

### Файл `settings.py` (для локального режима)

Этот файл используется, когда скрипт запущен с флагом `--local`.

```python
# settings.py

# Пути для чтения данных с диска
GROUP_1_DIR = r"C:\path\to\group1_images"
GROUP_2_DIR = r"C:\path\to\group2_images_database"

# Настройка логики замены/пропуска
KEEP_UNMATCHED_IMAGES = True  # True или False

# Технические параметры алгоритмов (влияют на точность и скорость)
RESIZE_WIDTH = 800
ORB_N_FEATURES = 2000
RANSAC_MIN_INLIERS = 15
```

## Логика замены и пропуска изображений

Поведение скрипта при обработке изображений, для которых не найден аналог, управляется параметром `KEEP_UNMATCHED_IMAGES` (в `settings.py`) или ключом `{CHAT_ID}:KEEP_UNMATCHED` (в Redis).

*   **Если значение `True` (поведение по умолчанию):**
    *   Если для изображения из `Group 1` найден аналог в `Group 2`, оно будет **заменено** на путь к аналогу.
    *   Если аналог **не найден**, в итоговый список будет добавлен **путь к исходному изображению** из `Group 1`.
    *   **Результат:** Количество изображений в итоговом списке всегда равно количеству изображений в исходной `Group 1`. Порядок полностью сохраняется.

*   **Если значение `False`:**
    *   Если для изображения из `Group 1` найден аналог в `Group 2`, оно будет **заменено**.
    *   Если аналог **не найден**, изображение будет **пропущено (отброшено)** и не попадет в итоговый список.
    *   **Результат:** В итоговом списке будут только те изображения, для которых нашлись аналоги. Относительный порядок найденных изображений сохраняется.

**Пример:** Исходный порядок: `[A, B, C]`. Аналог найден только для `B` и `C`.
*   При `KEEP_UNMATCHED_IMAGES = True`, результат будет: `[A, B_аналог, C_аналог]`.
*   При `KEEP_UNMATCHED_IMAGES = False`, результат будет: `[B_аналог, C_аналог]`.

## Использование

### Запуск в режиме Redis (по умолчанию)

1.  **Подготовьте данные** в Redis согласно таблице выше.
2.  **Установите переменную окружения `CHAT_ID`:**
    ```bash
    export CHAT_ID=123456789  # macOS/Linux
    set CHAT_ID=123456789    # Windows
    ```
3.  **Запустите скрипт:**
    ```bash
    python main.py
    ```

### Запуск в локальном режиме

1.  **Настройте пути** и параметры в файле `settings.py`.
2.  **Запустите скрипт с флагом `--local`:**
    ```bash
    python main.py --local
    ```